# bot/handlers/help_menu.py

from aiogram import types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from bot.app import dp
from bot.utils import block_if_active_flow

# ================= HELP TEXT BUILDERS =================
def _rtl_wrap(text: str) -> str:
    """Force right-to-left display even if text includes LTR parts."""
    RLI = "\u2067"  # Right-to-Left isolate
    PDI = "\u2069"  # Pop directional isolate
    RLM = "\u200F"  # Right-to-left mark
    return f"{RLM}{RLI}{text}{PDI}"


def build_help_chunks(max_len: int = 3500) -> list[str]:
    frame_top = "โโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    frame_mid = "โโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    box_top = "โญโโโโโโโโโโโโโโโโโโโโโโโโโฎ"
    box_bottom = "โฐโโโโโโโโโโโโโโโโโโโโโโโโโฏ"

    sections = [
        "๐ <b>ุฏููู ุงูุงุณุชุฎุฏุงู ุงูููุตู</b>",
        "",
        frame_top,
        _rtl_wrap("     ๐ <b>ุงูุจุฏุก ูุงูุชุณุฌูู</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /start โ ุชุณุฌูู ุฌุฏูุฏ ุฃู ูุญุต ุญุงูุฉ ุญุณุงุจู (ูุดุท/ุบูุฑ ูุดุท)."),
        _rtl_wrap(" ๐น ุฃุซูุงุก ุงูุชุณุฌูู: ุฃุฏุฎู ุงุณูู ุซู ุงุณู ุงูุดุจูุฉ ุซู ุฃุถู ุฎุทูุท ADSL ุฃู ุชุฎุทูู ูุฐู ุงูุฎุทูุฉ."),
        _rtl_wrap(" ๐น /help โ ุนุฑุถ ูุฐุง ุงูุฏููู ูู ุฃู ููุช."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐ <b>ุฅุฏุงุฑุฉ ุงูุดุจูุงุช</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /networks โ ุชุญุชูู ูุฐู ุงููุงุฆูุฉ:"),
        _rtl_wrap("     โข ุชุบููุฑ ุงูุดุจูุฉ ุงููุดุทุฉ, ุญูุซ ุงูุดุจูุฉ ุงููุดุทุฉ ุชุนุชุจุฑุงูุดุจูุฉ ุงูุฑุฆูุณูุฉ."),
        _rtl_wrap("     โข ุนุฑุถ ุดุจูุงุชู ุงูููุนูุฉ."),
        _rtl_wrap("     โข ุฅุถุงูุฉ ุดุจูุงุช ุฌุฏูุฏุฉ."),
        _rtl_wrap("     โข ุญุฐู ุดุจูุงุช ุชููููุง."),
        _rtl_wrap("     โข ุชุนุฏูู ุงุณู ุงูุดุจูุงุช ุงูุชู ุชููููุง."),
        _rtl_wrap("     โข ุชุบููุฑ ุงููุงุช ุงุฑุณุงู ุงูุชูุงุฑูุฑ ูุงูุชูุจููุงุช ููู ุดุจูุฉ ุณูุงุก ููุช ุงููุงูู ุฃู ุดุฑูู."),
        _rtl_wrap("     โข ุทูุจ ุชูุนูู ุดุจูุงุชู ุงููุนุทูุฉ ูู ูุจู ุงูุฅุฏุงุฑุฉ."),
        _rtl_wrap("     โข ุฅุฏุงุฑุฉ ุงูุดุฑูุงุก ููู ุดุจูุฉ ุชููููุง."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐ก <b>ุฅุฏุงุฑุฉ ุฎุทูุท ุงูุฅูุชุฑูุช (ADSL)</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /adsls โ ุชุญุชูู ูุฐู ุงููุงุฆูุฉ:"),
        _rtl_wrap("     โข ุนุฑุถ ุฎุทูุท ุงููุช ุงููุถุงูุฉ ููู ุดุจูุงุชู ุงููุดุทุฉ."),
        _rtl_wrap("     โข ุฅุถุงูุฉ ุฎุทูุท ูุช ุฌุฏูุฏุฉ ูุฃู ูู ุดุจูุงุชู ุงููุดุทุฉ."),
        _rtl_wrap("     โข ุฅุถุงูุฉ ุฎุทูุท ูุช ุนู ุทุฑูู ุฑูู ุงูุฎุท ูุจุงุดุฑุฉ ูู ุญุงู ูุงู ุงุณู ุงููุณุชุฎุฏู ูุฎุชูู ุนู ุฑูู ุงูุฎุท ููุท ุจุฃูู ุฑูููู."),
        _rtl_wrap("     โข ุฅุถุงูุฉ ุฎุทูุท ูุช ุนู ุทุฑูู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงูุณุฑ ูู ุญุงู ูุงู ุงุณู ุงููุณุชุฎุฏู ูุฎุชูู ุจุดูู ูุจูุฑ ุนู ุฑูู ADSL."),
        _rtl_wrap("     โข ุญุฐู ุฎุทูุท ุงููุช ูู ุฃู ูู ุดุจูุงุชู ุงูุชู ุงูุดุฃุชูุง."),
        _rtl_wrap("     โข ููู ุฎุทูุท ุงููุช ุจูู ุดุจูุงุชู ุงูุชู ุชููููุง ูุงูุชู ุชููู ุตูุงุญูุฉ ุงููุชุงุจุฉ ุนูููุง."),
        _rtl_wrap("     โข ุงุถุงูุฉ ุชุฑุชูุจ ุฎุงุต ูุฎุทูุท ุงููุช ุงูุชู ุชููููุง."),
        _rtl_wrap(" ๐น ุงูููู ูุชุทูุจ ุดุจูุชูู ูุงุจูุชูู ูููุชุงุจุฉ ุนูู ุงูุฃููุ ูุฅุญุฏู ุงูุดุจูุงุช ุชุญุชูู ุฎุทูุทูุง ููุฌูุฏุฉ."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐ <b>ุงูุชูุงุฑูุฑ ูุงููุชุงุจุนุฉ</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /reports โ ุชุญุชูู ูุฐู ุงููุงุฆูุฉ:"),
        _rtl_wrap("     โข ุชูุฑูุฑ ููุฑู ููุดุจูุฉ ุงููุดุทุฉ."),
        _rtl_wrap("     โข ุงุฎุชูุงุฑ ุดุจูุฉ ููุญุตูู ุนูู ุชูุฑูุฑ ููุฑู."),
        _rtl_wrap("     โข ุชูุฑูุฑ ููุฑู ููู ุงูุดุจูุงุช ุงูููุนูุฉ ุณูุงุก ููุช ุงููุงูู ุฃู ุดุฑูู."),
        _rtl_wrap("     โข ุงุฎุชูุงุฑ ุชุงุฑูุฎ ูุญุฏุฏ ููุญุตูู ุนูู ุชูุงุฑูุฑ ุชุงุฑูุฎูุฉ ููู ุฃู ุจุนุถ ุงูุดุจูุงุช."),
        _rtl_wrap(" ๐น ุงููุงุช ุงูุญุตูู ุนูู ุงูุชูุงุฑูุฑ: ููููู ุถุจุท ุฃููุงุช ุฅุฑุณุงู ุงูุชูุงุฑูุฑ ูุงูุชูุจููุงุช ูู ุงูุฅุนุฏุงุฏุงุช ุงู ูู ูุงุฆูุฉ ุงูุดุจูุงุช"),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐งพ <b>ููุฎุต ุงูุญุณุงุจ</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /account โ ุนุฑุถ ููุฎุต ุญุณุงุจู ุงูุญุงูู:"),
        _rtl_wrap("     โข ุงูุดุจูุฉ ุงููุดุทุฉ ุญุงููุงู."),
        _rtl_wrap("     โข ูุนุฑู ูุงุณู ุงููุดุชุฑู ููู ููู ุนูุฏ ุงูุชูุงุตู ูุน ุงูุฏุนู."),
        _rtl_wrap("     โข ุดุจูุงุช ุงููุงูู ูุงูุดุฑูู ูุน ุชูุงุตูู ุงููุนุฑูุ ุงูุตูุงุญูุฉุ ูุงูุญุงูุฉ (ูุดุท/ุบูุฑ ูุดุท)."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐ค <b>ุงูุดุฑูุงุก</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /partners โ ุฅุฏุงุฑุฉ ุงูุดุฑูุงุก ูุญุณุงุจู:"),
        _rtl_wrap("     โข ุฅุถุงูุฉ ุดุฑูุงุก ูุญุณุงุจู ููุณูุงุญ ููู ุจูุณุงุนุฏุชู ูู ุฅุฏุงุฑุฉ ุดุจูุงุชู ูุงูุญุตูู ุนูู ุชูุงุฑูุฑูุง."),
        _rtl_wrap("     โข ููููู ุงุฎุชูุงุฑ ุตูุงุญูุงุช ุงูุดุฑูู (ูุฑุงุกุฉ ููุท ุฃู ูุฑุงุกุฉ ููุชุงุจุฉ ุงู ูุงูู) ุนูุฏ ุฅุถุงูุชู."),
        _rtl_wrap("     โข ุญุฐู ุงูุดุฑูุงุก ูู ุญุณุงุจู ูู ุฃู ููุช."),
        _rtl_wrap("     โข ุชุนุทูู ุงูุดุฑูุงุก ูุคูุชูุง ุฏูู ุญุฐููู."),
        _rtl_wrap("     โข ุชุนุฏูู ุตูุงุญูุงุช ุงูุดุฑูุงุก ุฃู ูุนูููุงุชูู."),
        _rtl_wrap(" ๐น ุงูุตูุงุญูุงุช ุงูุชู ุชููุญูุง ููุดุฑูู ุชุญุฏุฏ ูุง ููููู ูุนูู (ูุฑุงุกุฉ ููุท ุฃู ูุชุงุจุฉ)."),
        _rtl_wrap(" ๐น ุงูุดุฑูู ุงููุงูู ููููู ุฅุฏุงุฑุฉ ุงูุดุจูุงุช ุงูุชู ุชููููุง ุจุงููุงูู ุจูุง ูู ุฐูู ุงูุฅุถุงูุฉุ ุงูุญุฐูุ ูุงูุชุนุฏูู ุจุงุณุชุซูุงุก ุฅุฏุงุฑุฉ ุงูุดุฑูุงุก."),
        _rtl_wrap(" ๐น ุงูุดุฑูุงุก ุจุตูุงุญูุฉ ูุฑุงุกุฉ ูุง ูููููู ุชุนุฏูู ุงู ุดู ููุท ุงูุญุตูู ุนูู ุงูุชูุงุฑูุฑ."),
        
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     โ๏ธ <b>ุงูุฅุนุฏุงุฏุงุช</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /settings โ ุชุญุชูู ูุฐู ุงููุงุฆูุฉ:"),
        _rtl_wrap("     โข ุชุนุฏูู ุงุณู ุงููุดุชุฑู."),
        _rtl_wrap("     โข ุชุนุฏูู ุงููุงุช ุงุณุชูุงู ุงูุชูุงุฑูุฑ ููู ุงู ุจุนุถ ุงูุดุจูุงุช."),
        _rtl_wrap("     โข ุชุนุฏูู ุงุนุฏุงุฏุงุช ุงูุชูุจููุงุช ุงูุฎุงุตุฉ ุจู ูุซู ุงูุชูุจูู ุนูุฏ ุงูุชุฑุงุจ ุงูุชูุงุก ุตูุงุญูุฉ ุงูุดุจูุฉ."),
        _rtl_wrap("     โข ุชูุนูู/ุฅููุงู ุงูุญุตูู ุนูู ุชูุงุฑูุฑ ุงูุดุฑูุงุก ุญูุซ ุงุฐุง ูุงู ููุนู ุณูู ุชุณุชูู ุชูุงุฑูุฑ ุนูุฏ ุทูุจ ุงุญุฏ ุดุฑูุงุฆู ูุชูุฑูุฑ ููุฑู."),
        _rtl_wrap("     โข ุชุนุฏูู ุชุฑุชูุจ ุฎุทูุท ุงููุช ุนูุฏ ุงูุดุงุก ุชูุงุฑูุฑ ุงูุดุจูุงุช, ุฐูู ุณูุทุจู ุนูู ุฌููุน ุงูุดุจูุงุช."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     โน๏ธ <b>ุงูุฏุนู ูุงููุนูููุงุช</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น /about โ ูุนูููุงุช ุนู ุงูุจูุช ูููููุฉ ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ููุฏุนู."),
        _rtl_wrap(" ๐น /help โ ุนุฑุถ ูุฐุง ุงูุฏููู ูู ุฃู ููุช."),
        box_bottom,
        "",
        frame_top,
        _rtl_wrap("     ๐ก <b>ูุตุงุฆุญ ุณุฑูุนุฉ</b>"),
        frame_mid,
        "",
        box_top,
        _rtl_wrap(" ๐น ุงุณุชุฎุฏู ุงูุฃูุงูุฑ ูู ุงูููุงุฆู ุฃู ููุญุฉ ุงูุฃูุงูุฑ ุจุฏูุงู ูู ุงููุชุงุจุฉ ุงููุฏููุฉ ูุชุฌูุจ ุงูุฃุฎุทุงุก."),
        _rtl_wrap(" ๐น ุนูุฏ ุงุถุงูุฉ ุฎุทูุท ุชุฃูุฏ ูู ุงู ุงูุงุฎุชูุงู ูู ุงุณู ุงููุณุชุฎุฏู ูุฑูู ADSL ููุท ูู ุงูู ุฑูููู, ูู ุญุงูุฉ ูุงู ุงูุงุฎุชูุงู ูุจูุฑ ูุฌุจ ุงู ุชุฎุชุงุฑ ุฎูุงุฑ ุงุถุงูุฉ ุฎุทูุท ูุช ุนู ุทุฑูู ุงุณู ุงููุณุชุฎุฏู ูุฑูู ADSL."),
        _rtl_wrap(" ๐น ูู ุญุงู ูุงูุช ุงูุดุจูุฉ ูุนุทูุฉ ูู ูุจู ุงูุฅุฏุงุฑุฉุ ูู ุชุธูุฑ ูู ุงู ุนูููุฉ ููุชุฃูุฏ ูู ุดุจูุงุชู ุงููุนุทูุฉ ุงูุชุญ ูุงุฆูุฉ ุงูุดุจูุงุช, ุทูุจ ุชูุนูู ุดุจูุฉ, ูุชุญูู ูุง ุงุฐุง ูุงูุช ุงูุดุจูุฉ ููุนูุฉ."),
        _rtl_wrap(" ๐น ููููู ุงุถุงูุฉ ุงูุซุฑ ูู ุดุจูุฉ ุชููููุง ุงู ุดุฑูู ุนูููุง, ูุชุจุฏูู ุงูุดุจูุฉ ุงููุดุทุฉ ูู ุงู ููุช ูู ูุงุฆูุฉ ุงูุดุจูุงุช."),
        _rtl_wrap(" ๐น ููููู ุงุถุงูุฉ ุงูุซุฑ ูู ุดุฑูู ูุญุณุงุจู, ูุน ุชุญุฏูุฏ ุตูุงุญูุงุช ูู ุดุฑูู ุนูู ุญุฏู."),
        _rtl_wrap(" ๐น ููููู ุทูุจ ุชูุนูู ุดุจูุงุชู ุงููุนุทูุฉ ูู ูุจู ุงูุฅุฏุงุฑุฉ ูู ูุงุฆูุฉ ุงูุดุจูุงุช."),
        _rtl_wrap(" ๐น ููููู ููู ุฎุทูุท ุงููุช ุจูู ุดุจูุงุชู ุงูุชู ุชููููุง ุจุดุฑุท ุงู ุชูุชูู ุตูุงุญูุงุช ุชูููู ูู ุงูุชุนุฏูู ุนูู ุงูุดุจูุชูู."),
        _rtl_wrap(" ๐น ุชุฃูุฏ ูู ุตูุงุญูุงุชู (ูุงูู/ุดุฑูู ูุฑุงุกุฉ ุฃู ูุชุงุจุฉ) ูุจู ูุญุงููุฉ ููู ุฃู ุญุฐู ุงูุฎุทูุท."),
        _rtl_wrap(" ๐น ููููู ุทูุจ ุชูุงุฑูุฑ ููุฑูุฉ ูุฃู ูู ุดุจูุงุชู ุงูููุนูุฉ ุณูุงุก ููุช ุงููุงูู ุฃู ุดุฑูู."),
        _rtl_wrap(" ๐น ููููู ุชุนุฏูู ุงููุงุช ุงุฑุณุงู ุงูุชูุงุฑูุฑ ูุงูุชูุจููุงุช ููู ุดุจูุฉ ูู ูุงุฆูุฉ ุงูุดุจูุงุช ุงู ูู ุงูุงุนุฏุงุฏุงุช."),
        box_bottom,
        "",
    ]
    chunks: list[str] = []
    current: list[str] = []
    current_len = 0

    for part in sections:
        part_len = len(part) + 1  # account for newline
        if current and current_len + part_len > max_len:
            chunks.append("\n".join(current))
            current = [part]
            current_len = part_len
        else:
            current.append(part)
            current_len += part_len

    if current:
        chunks.append("\n".join(current))

    total = len(chunks)
    for idx in range(total):
        footer = f"\n\nโบ๏ธ ุงูุฌุฒุก {idx + 1}/{total}"
        chunks[idx] = f"{chunks[idx]}{footer}"

    return chunks


# ================= HANDLERS =================
@dp.message(Command("help"))
async def help_command(message: types.Message, state: FSMContext):
    if await block_if_active_flow(message, state):
        return
    chunks = build_help_chunks()
    total = len(chunks)

    for idx, chunk in enumerate(chunks):
        is_last = idx == total - 1
        kb = None
        if is_last:
            kb = InlineKeyboardMarkup(
                inline_keyboard=[[InlineKeyboardButton(text="โ ุฅุบูุงู", callback_data="help_close")]]
            )
        await message.answer(chunk, reply_markup=kb, parse_mode="HTML")


@dp.callback_query(F.data == "help_close")
async def help_close(call: types.CallbackQuery):
    await call.answer()
    try:
        await call.message.delete()
    except Exception:
        pass
